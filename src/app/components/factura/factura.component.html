<div class="container mx-auto max-w-6xl px-4 py-6">
  <div class="space-y-8">
    <!-- Encabezado con Logo -->
    <div class="alert alert-info shadow-xl">
      <div class="flex items-center justify-between w-full">
        <div class="flex items-center gap-4">
          <div class="bg-base-100 rounded-lg p-3 shrink-0">
            <svg class="w-10 h-10 text-primary" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <div>
            <h2 class="text-3xl font-bold">Nueva Factura</h2>
            <p class="opacity-80">Complete todos los campos requeridos</p>
          </div>
        </div>
        <div class="text-center shrink-0 ml-4">
          <div class="text-5xl font-bold">{{ lineas.length }}</div>
          <div class="text-sm opacity-80">Líneas</div>
        </div>
      </div>
    </div>

  <!-- Mensaje de Éxito -->
  <div *ngIf="mensajeExito" class="alert alert-success shadow-lg">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
    </svg>
    <span>¡Factura enviada correctamente!</span>
  </div>

  <form [formGroup]="facturaForm" (ngSubmit)="enviarFactura()">
    <!-- Datos de la Factura -->
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body">
        <h3 class="card-title text-xl flex items-center mb-4">
          <svg class="w-6 h-6 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Datos de la Factura
        </h3>
      
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="form-control w-full">
            <label class="label justify-start">
              <span class="label-text font-semibold">Número de Factura <span class="text-error">*</span></span>
            </label>
            <input 
              type="text" 
              formControlName="numeroFactura"
              placeholder="Ej: 123456"
              class="input input-bordered"
              [class.input-error]="esInvalido('numeroFactura')"
            >
            <label *ngIf="esInvalido('numeroFactura')" class="label">
              <span class="label-text-alt text-error">
                <span *ngIf="facturaForm.get('numeroFactura')?.hasError('required')">El número de factura es obligatorio</span>
                <span *ngIf="facturaForm.get('numeroFactura')?.hasError('pattern')">Solo se permiten números</span>
              </span>
            </label>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Fecha <span class="text-error">*</span></span>
            </label>
            <input 
              type="date" 
              formControlName="fecha"
              class="input input-bordered"
              [class.input-error]="esInvalido('fecha')"
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Datos del Cliente -->
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body">
        <h3 class="card-title text-xl flex items-center mb-4">
          <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
          </svg>
          Datos del Cliente
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2 form-control w-full">
            <label class="label justify-start">
              <span class="label-text font-semibold">Nombre / Razón Social <span class="text-error">*</span></span>
            </label>
            <input 
              type="text" 
              formControlName="nombreCliente"
              placeholder="Nombre completo o razón social"
              class="input input-bordered"
              [class.input-error]="esInvalido('nombreCliente')"
            >
            <label *ngIf="esInvalido('nombreCliente')">
              <span class="label-text-alt text-error">El nombre debe tener al menos 3 caracteres</span>
            </label>
          </div>

          <div class="md:col-span-2 form-control w-full">
            <label class="label">
              <span class="label-text font-semibold">Dirección <span class="text-error">*</span></span>
            </label>
            <input 
              type="text" 
              formControlName="direccion"
              placeholder="Calle, número, piso..."
              class="input input-bordered"
              [class.input-error]="esInvalido('direccion')"
            >
          </div>

          <div class="form-control w-full">
            <label class="label">
              <span class="label-text font-semibold">Provincia <span class="text-error">*</span></span>
            </label>
            <input 
              type="text" 
              formControlName="provincia"
              placeholder="Provincia"
              class="input input-bordered"
              [class.input-error]="esInvalido('provincia')"
            >
          </div>

          <div class="form-control w-full">
            <label class="label">
              <span class="label-text font-semibold">Ciudad <span class="text-error">*</span></span>
            </label>
            <input 
              type="text" 
              formControlName="ciudad"
              placeholder="Ciudad"
              class="input input-bordered"
              [class.input-error]="esInvalido('ciudad')"
            >
          </div>

          <div class="form-control w-full">
            <label class="label">
              <span class="label-text font-semibold">Tipo Documento <span class="text-error">*</span></span>
            </label>
            <select 
              formControlName="tipoDocumento"
              class="select select-bordered"
            >
              <option value="NIF">NIF</option>
              <option value="CIF">CIF</option>
              <option value="Pasaporte">Pasaporte</option>
            </select>
          </div>

          <div class="form-control w-full">
            <label class="label">
              <span class="label-text font-semibold">Número Documento <span class="text-error">*</span></span>
            </label>
            <input 
              type="text" 
              formControlName="numeroDocumento"
              placeholder="12345678A"
              class="input input-bordered uppercase"
              [class.input-error]="esInvalido('numeroDocumento')"
            >
            <label *ngIf="esInvalido('numeroDocumento')" class="label">
              <span class="label-text-alt text-error">
                <span *ngIf="facturaForm.get('numeroDocumento')?.hasError('nifInvalido')">NIF inválido (8 números + letra)</span>
                <span *ngIf="facturaForm.get('numeroDocumento')?.hasError('cifInvalido')">CIF inválido (Letra + 7 números + dígito)</span>
              </span>
            </label>
          </div>

          <div class="form-control w-full">
            <label class="label">
              <span class="label-text font-semibold">Teléfono <span class="text-error">*</span></span>
            </label>
            <input 
              type="tel" 
              formControlName="telefono"
              placeholder="123456789"
              class="input input-bordered"
              [class.input-error]="esInvalido('telefono')"
            >
            <label *ngIf="esInvalido('telefono')" class="label">
              <span class="label-text-alt text-error">Debe tener 9 dígitos</span>
            </label>
          </div>

          <div class="form-control w-full">
            <label class="label">
              <span class="label-text font-semibold">Email <span class="text-error">*</span></span>
            </label>
            <input 
              type="email" 
              formControlName="email"
              placeholder="ejemplo@correo.com"
              class="input input-bordered"
              [class.input-error]="esInvalido('email')"
            >
            <label *ngIf="esInvalido('email')" class="label">
              <span class="label-text-alt text-error">Email inválido</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Añadir Líneas -->
    <div class="card bg-accent/10 shadow-xl mb-6">
      <div class="card-body">
        <h3 class="card-title text-xl flex items-center">
          <svg class="w-6 h-6 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Añadir Línea de Factura
        </h3>

        <form [formGroup]="lineaForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="md:col-span-2 form-control w-full">
              <label class="label">
                <span class="label-text font-semibold">Artículo</span>
              </label>
              <input 
                type="text" 
                formControlName="articulo"
                placeholder="Descripción del artículo"
                class="input input-bordered"
                [class.input-error]="esInvalidoLinea('articulo')"
              >
            </div>

            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-semibold">Cantidad</span>
              </label>
              <input 
                type="number" 
                formControlName="cantidad"
                min="1"
                class="input input-bordered"
                [class.input-error]="esInvalidoLinea('cantidad')"
              >
            </div>

            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-semibold">Precio (€)</span>
              </label>
              <input 
                type="number" 
                formControlName="precio"
                step="0.01"
                min="0"
                class="input input-bordered"
                [class.input-error]="esInvalidoLinea('precio')"
              >
            </div>

            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-semibold">IVA</span>
              </label>
              <select 
                formControlName="tipoIva"
                class="select select-bordered"
              >
                <option [value]="21">21%</option>
                <option [value]="10">10%</option>
                <option [value]="4">4%</option>
              </select>
            </div>
          </div>

          <button 
            type="button"
            (click)="agregarLinea()"
            class="btn btn-accent w-full"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Agregar Línea
          </button>
        </form>
      </div>
    </div>

    <!-- Tabla de Líneas -->
    <div *ngIf="lineas.length > 0" class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body p-0">
        <div class="bg-neutral text-neutral-content px-6 py-4 rounded-t-2xl">
          <h3 class="text-xl font-bold flex items-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            Líneas de Factura
          </h3>
        </div>

        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>ID</th>
                <th>Artículo</th>
                <th class="text-center">Cantidad</th>
                <th class="text-right">Precio</th>
                <th class="text-center">IVA</th>
                <th class="text-right">Base</th>
                <th class="text-right">Imp. IVA</th>
                <th class="text-right">Total</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let linea of lineas">
                <td class="font-medium">{{ linea.id }}</td>
                <td>{{ linea.articulo }}</td>
                <td class="text-center">{{ linea.cantidad }}</td>
                <td class="text-right">{{ linea.precio | number:'1.2-2' }} €</td>
                <td class="text-center">
                  <span class="badge"
                        [class.badge-error]="linea.tipoIva === 21"
                        [class.badge-warning]="linea.tipoIva === 10"
                        [class.badge-success]="linea.tipoIva === 4">
                    {{ linea.tipoIva }}%
                  </span>
                </td>
                <td class="text-right font-medium">{{ linea.base | number:'1.2-2' }} €</td>
                <td class="text-right">{{ linea.iva | number:'1.2-2' }} €</td>
                <td class="text-right font-bold">{{ linea.total | number:'1.2-2' }} €</td>
                <td class="text-center">
                  <button 
                    type="button"
                    (click)="eliminarLinea(linea.id)"
                    class="btn btn-error btn-sm"
                    title="Eliminar línea"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Resumen de Totales -->
    <div *ngIf="lineas.length > 0" class="card bg-success/10 shadow-xl mb-6">
      <div class="card-body">
        <h3 class="card-title text-xl flex items-center">
          <svg class="w-6 h-6 mr-2 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
          </svg>
          Resumen de IVA
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div *ngIf="baseImponible21 > 0" class="stats shadow border-l-4 border-error">
            <div class="stat">
              <div class="stat-title">Base Imponible (21%)</div>
              <div class="stat-value text-2xl">{{ baseImponible21 | number:'1.2-2' }} €</div>
              <div class="stat-desc">IVA (21%): {{ iva21 | number:'1.2-2' }} €</div>
            </div>
          </div>

          <div *ngIf="baseImponible10 > 0" class="stats shadow border-l-4 border-warning">
            <div class="stat">
              <div class="stat-title">Base Imponible (10%)</div>
              <div class="stat-value text-2xl">{{ baseImponible10 | number:'1.2-2' }} €</div>
              <div class="stat-desc">IVA (10%): {{ iva10 | number:'1.2-2' }} €</div>
            </div>
          </div>

          <div *ngIf="baseImponible4 > 0" class="stats shadow border-l-4 border-success">
            <div class="stat">
              <div class="stat-title">Base Imponible (4%)</div>
              <div class="stat-value text-2xl">{{ baseImponible4 | number:'1.2-2' }} €</div>
              <div class="stat-desc">IVA (4%): {{ iva4 | number:'1.2-2' }} €</div>
            </div>
          </div>
        </div>

        <div class="alert alert-success shadow-xl">
          <div class="flex justify-between items-center w-full">
            <span class="text-xl font-bold">TOTAL FACTURA</span>
            <span class="text-4xl font-bold">{{ totalFactura | number:'1.2-2' }} €</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Captcha -->
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body">
        <h3 class="card-title text-xl flex items-center">
          <svg class="w-6 h-6 mr-2 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
          </svg>
          Verificación de Seguridad
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
          <div class="alert alert-info">
            <div class="w-full text-center">
              <p class="text-lg mb-2">Resuelve la operación:</p>
              <p class="text-4xl font-bold">
                {{ captchaNumero1 }} + {{ captchaNumero2 }} = ?
              </p>
            </div>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold text-lg">Tu Respuesta <span class="text-error">*</span></span>
            </label>
            <input 
              type="number" 
              formControlName="captcha"
              placeholder="Escribe el resultado"
              class="input input-bordered input-lg"
              [class.input-error]="esInvalido('captcha')"
            >
            <label *ngIf="esInvalido('captcha')" class="label">
              <span class="label-text-alt text-error">Respuesta incorrecta</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Botones de Acción -->
    <div class="flex flex-col md:flex-row gap-4">
      <button 
        type="submit"
        [disabled]="enviando || lineas.length === 0"
        class="btn btn-success btn-lg flex-1"
      >
        <svg *ngIf="!enviando" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span *ngIf="enviando" class="loading loading-spinner"></span>
        {{ enviando ? 'Enviando...' : 'Enviar Factura' }}
      </button>

      <button 
        type="button"
        (click)="reiniciarFormulario()"
        class="btn btn-neutral btn-lg flex-1"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Limpiar Formulario
      </button>
    </div>
  </form>
  </div>
</div>
